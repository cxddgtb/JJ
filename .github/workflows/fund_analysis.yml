name: 基金数据分析与买卖点生成

on:
  schedule:
    # 每天早上9点运行（北京时间）
    - cron: '1 16 * * *'
  workflow_dispatch:
    inputs:
      fund_type:
        description: '基金类型'
        required: true
        default: 'mixed'
        type: choice
        options:
        - mixed
        - stock
        - bond
        - money_market
        - qdii
      analysis_depth:
        description: '分析深度'
        required: true
        default: 'medium'
        type: choice
        options:
        - basic
        - medium
        - deep

jobs:
  fund-analysis:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || pip install --no-cache-dir -r requirements.txt --extra-index-url https://pypi.douban.com/simple/ || echo "依赖安装失败，将尝试直接安装核心依赖"
        pip install --no-cache-dir requests beautifulsoup4 pandas numpy lxml selenium fake-useragent --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "核心依赖安装失败，将尝试使用默认源"
        pip install --no-cache-dir requests beautifulsoup4 pandas numpy lxml selenium fake-useragent || echo "核心依赖安装失败，将尝试逐个安装"
        pip install --no-cache-dir requests || pip install requests --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "requests安装失败"
        pip install --no-cache-dir beautifulsoup4 || pip install beautifulsoup4 --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "beautifulsoup4安装失败"
        pip install --no-cache-dir pandas || pip install pandas --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "pandas安装失败"
        pip install --no-cache-dir numpy || pip install numpy --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "numpy安装失败"
        pip install --no-cache-dir lxml || pip install lxml --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "lxml安装失败"
        pip install --no-cache-dir selenium || pip install selenium --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "selenium安装失败"
        pip install --no-cache-dir fake-useragent || pip install fake-useragent --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "fake-useragent安装失败"
        pip install --no-cache-dir tushare akshare baostock --extra-index-url https://pypi.tuna.tsinghua.edu.cn/simple/ || echo "数据获取库安装失败"

    - name: 创建必要目录
      run: |
        mkdir -p outputs/raw_data
        mkdir -p outputs/processed_data
        mkdir -p outputs/analysis_results
        mkdir -p outputs/articles

    - name: 获取免费API列表
      id: get-apis
      run: |
        python src/get_free_apis.py
        echo "api_count=$(cat free_apis.txt | wc -l)" >> $GITHUB_OUTPUT
        # 将免费API文件复制到工作目录
        cp free_apis.txt src/ || echo "免费API文件不存在，跳过复制"

    - name: 并行新闻搜索
      run: python src/news_crawler.py --fund-type ${{ github.event.inputs.fund_type || 'mixed' }} --threads 5
      env:
        SEARCH_ENGINES: "baidu,google,bing,sogou,360"
        MAX_NEWS_COUNT: 50

    - name: 并行数据爬取
      run: python src/data_crawler.py --fund-type ${{ github.event.inputs.fund_type || 'mixed' }} --threads 8
      env:
        API_PROVIDERS: "tushare,akshare,jqdata,baostock,free_apis"

    - name: 数据处理与分析
      run: |
        python src/indicators.py --fund-type ${{ github.event.inputs.fund_type || 'mixed' }}
        python src/ai_analysis.py --fund-type ${{ github.event.inputs.fund_type || 'mixed' }} --depth ${{ github.event.inputs.analysis_depth || 'medium' }}

    - name: 生成买卖操作文章
      run: |
        python src/article_generator.py --fund-type ${{ github.event.inputs.fund_type || 'mixed' }}

    - name: AI润色文章
      run: |
        python src/polish_article.py --fund-type ${{ github.event.inputs.fund_type || 'mixed' }}

    - name: 上传结果
      uses: actions/upload-artifact@v4
      with:
        name: analysis-results
        path: outputs/

    - name: 提交文章到仓库
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local --add url."https://github.com/".insteadOf "git@github.com:"
        git add outputs/articles/*.md
        git diff --staged --quiet || git commit -m "更新基金分析文章: ${{ github.event.inputs.fund_type || 'mixed' }}基金"
        git push
        echo "文章已成功提交到仓库"
