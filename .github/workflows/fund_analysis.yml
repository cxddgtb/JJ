name: åŸºé‡‘æ•°æ®çˆ¬å–ä¸åˆ†æ

on:
  schedule:
    - cron: '0 9,15,21 * * 1-5'  # å·¥ä½œæ—¥9ç‚¹ã€15ç‚¹ã€21ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths-ignore:
      - 'reports/**'
      - 'data/**'
      - 'cache/**'
      - 'logs/**'
      - 'backup/**'
      - '*.md'
      - '*.json'
      - '*.log'

jobs:
  fund-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      continue-on-error: true
      run: |
        python -m pip install --upgrade pip
        # åˆ†æ­¥å®‰è£…ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
        echo "=== å®‰è£…æ ¸å¿ƒç½‘ç»œåŒ… ==="
        pip install requests urllib3 certifi || echo "ç½‘ç»œåŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…æ•°æ®å¤„ç†åŒ… ==="
        pip install pandas numpy || echo "æ•°æ®å¤„ç†åŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…ç½‘é¡µè§£æåŒ… ==="
        pip install beautifulsoup4 lxml || echo "è§£æåŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…å›¾è¡¨åŒ… ==="
        pip install matplotlib plotly seaborn || echo "å›¾è¡¨åŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…é‡‘èæ•°æ®åŒ… ==="
        pip install akshare yfinance || echo "é‡‘èåŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…åˆ†æåŒ… ==="
        pip install scikit-learn scipy || echo "åˆ†æåŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…å·¥å…·åŒ… ==="
        pip install PyYAML Jinja2 markdown python-dateutil pytz jieba wordcloud || echo "å·¥å…·åŒ…å®‰è£…å¤±è´¥"
        
        echo "=== å°è¯•å®‰è£…å¯é€‰æŠ€æœ¯åˆ†æåŒ… ==="
        pip install TA-Lib || echo "TA-Libå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å†…ç½®æ›¿ä»£æ–¹æ¡ˆ"
        pip install ta || echo "taåŒ…å®‰è£…å¤±è´¥"

        echo "=== å®‰è£…å…¶ä»–å¸¸ç”¨åŒ… ==="
        pip install schedule python-dotenv fake-useragent retrying cachetools || echo "å…¶ä»–åŒ…å®‰è£…å¤±è´¥"
        
        echo "=== å°è¯•å®‰è£…æ‰€æœ‰å‰©ä½™ä¾èµ– ==="
        pip install -r requirements.txt || echo "å®Œæ•´å®‰è£…å¤±è´¥ï¼Œä½¿ç”¨å·²å®‰è£…çš„åŒ…ç»§ç»­"
        
        echo "=== æ˜¾ç¤ºå·²å®‰è£…çš„åŒ… ==="
        pip list | grep -E "(pandas|numpy|matplotlib|plotly|seaborn|requests|akshare|yfinance|beautifulsoup4|lxml|scikit-learn|jieba|wordcloud|talib)" || echo "åŒ…æ£€æŸ¥å®Œæˆ"

    - name: è®¾ç½®æ—¶åŒº
      run: |
        sudo timedatectl set-timezone Asia/Shanghai

    - name: è¿è¡ŒåŸºé‡‘æ•°æ®çˆ¬å–
      continue-on-error: true
      env:
        REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
      run: |
        echo "=== ğŸš€ å¯åŠ¨ç®€å•åŸºé‡‘åˆ†æç³»ç»Ÿ ==="
        python simple_fund_analysis.py || {
          echo "âš ï¸ ç®€å•ç‰ˆå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ1"
          python src/robust_main.py || {
            echo "âš ï¸ å¤‡ç”¨æ–¹æ¡ˆ1å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ2"
            python src/ai_main.py || {
              echo "âš ï¸ å¤‡ç”¨æ–¹æ¡ˆ2å¤±è´¥ï¼Œå°è¯•æœ€åæ–¹æ¡ˆ"
              python src/main.py || {
                echo "âŒ æ‰€æœ‰ç¨‹åºéƒ½å¤±è´¥ï¼Œå¯åŠ¨ç´§æ€¥æŠ¥å‘Šç”Ÿæˆå™¨"
                python emergency_report.py
                echo "ğŸš¨ ç´§æ€¥æŠ¥å‘Šç”Ÿæˆå™¨å·²æ‰§è¡Œ"
                exit 0
              }
            }
          }
        }
        echo "âœ… åŸºé‡‘åˆ†æç³»ç»Ÿè¿è¡Œå®Œæˆ"

    - name: æäº¤åˆ†æç»“æœ
      env:
        REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„å˜åŒ–"
        else
          git commit -m "[skip ci] è‡ªåŠ¨æ›´æ–°åŸºé‡‘åˆ†ææŠ¥å‘Š $(date '+%Y-%m-%d %H:%M:%S')"
          git push https://x-access-token:${{ secrets.REPO_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
        fi

    - name: å‘é€é€šçŸ¥
      if: always()
      continue-on-error: true
      run: |
        # å°è¯•å®‰è£…é€šçŸ¥æ‰€éœ€çš„åŸºç¡€åŒ…
        pip install requests || echo "å®‰è£…requestså¤±è´¥"

        # å‘é€é€šçŸ¥
        python src/notification.py "${{ job.status }}" || {
          echo "Pythoné€šçŸ¥è„šæœ¬å¤±è´¥ï¼Œå°è¯•ç®€å•é€šçŸ¥"
          echo "GitHub Actions å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          echo "æ—¶é—´: $(date)"
          echo "ä»“åº“: ${{ github.repository }}"
        }
